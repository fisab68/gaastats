<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GAA Stats">
<title>GAA Hurling Stats</title>
<!--
  GAA HURLING STATS PWA v6
  ========================
  20 KPI buttons in a 4x5 grid â€” single tap records event + timestamp.
  Per-quarter Q-bars on each button show where events are clustering.
  Quarter pills show running score per quarter.
  Stats modal has two tabs: KPI Dashboard (calculated metrics vs targets)
  and Raw Counts (every KPI broken down by quarter, grouped by category).
  Fully offline via Service Worker. Persists across reloads via localStorage.
-->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;900&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --text: #e8eef8;
    --text-dim: #6b7a99;
    --accent: #00d4ff;
    --green: #00e676;
    --red: #ff3d5a;
    --amber: #ffab40;
    --purple: #b388ff;
    --flash: #00ff88;
    --radius: 14px;
    --radius-sm: 9px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }

  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 8px 8px 6px;
    gap: 5px;
  }

  /* SCOREBOARD */
  #scoreboard {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 5px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .score-team { display: flex; flex-direction: column; align-items: center; gap: 1px; }
  .score-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
  .score-block { display: flex; align-items: baseline; gap: 5px; }
  .score-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px; line-height: 1; letter-spacing: 2px;
    color: var(--text); transition: color 0.2s;
  }
  .score-total {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px; line-height: 1;
    color: var(--text-dim); transition: color 0.2s;
  }
  .score-value.flash-score, .score-total.flash-score { color: var(--flash); }
  #match-info { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  #quarter-label { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); }
  #match-clock { font-family: 'Bebas Neue', sans-serif; font-size: 26px; color: var(--text); letter-spacing: 1px; transition: color 0.2s; }
  #match-clock.paused { color: var(--amber); }
  #game-status { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); }

  /* Clock row with adjust buttons */
  #clock-row { display: flex; align-items: center; gap: 6px; }
  .clock-adj {
    font-family: 'Inter', sans-serif;
    font-size: 10px; font-weight: 900;
    letter-spacing: 0px; line-height: 1;
    padding: 5px 7px;
    border-radius: 7px;
    border: 1.5px solid rgba(107,122,153,0.3);
    background: rgba(107,122,153,0.1);
    color: var(--text-dim);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s, color 0.15s, transform 0.1s;
    white-space: nowrap;
  }
  .clock-adj:active { transform: scale(0.88); }
  .clock-adj.minus:active { background: rgba(255,61,90,0.2); border-color: rgba(255,61,90,0.5); color: var(--red); }
  .clock-adj.plus:active  { background: rgba(0,230,118,0.2); border-color: rgba(0,230,118,0.5); color: var(--green); }
  .clock-adj.disabled { opacity: 0.2; pointer-events: none; }

  /* QUARTER PILLS */
  #quarter-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
    flex-shrink: 0;
  }
  .qtr-pill {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-dim);
    font-size: 11px; font-weight: 700;
    letter-spacing: 1px; padding: 7px 4px;
    text-transform: uppercase;
    text-align: center;
    pointer-events: none;
    transition: background 0.3s, border-color 0.3s, color 0.3s, box-shadow 0.3s;
    display: flex; flex-direction: column; align-items: center; gap: 0px;
  }
  .qtr-pill.active {
    background: var(--accent); border-color: var(--accent);
    color: #000; box-shadow: 0 0 14px rgba(0,212,255,0.4);
  }
  .qtr-pill.done { border-color: rgba(0,212,255,0.3); color: rgba(0,212,255,0.5); }
  .qtr-score { font-size: 10px; font-weight: 700; margin-top: 1px; }
  .qtr-pill.active .qtr-score { color: #000; }
  .qtr-pill.done .qtr-score { color: rgba(0,212,255,0.6); }
  .qtr-pill:not(.active):not(.done) .qtr-score { color: var(--text-dim); opacity: 0.5; }

  /* KPI GRID */
  #kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 5px;
    flex: 1;
    min-height: 0;
  }

  .kpi-btn {
    position: relative; overflow: hidden;
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 0px; padding: 4px 4px 2px;
    transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    -webkit-tap-highlight-color: transparent;
  }

    .kpi-btn.cat-green  { background: linear-gradient(145deg, #0d2010, #0a1a0d); border-color: #1a4020; }
  .kpi-btn.cat-red    { background: linear-gradient(145deg, #200d0d, #1a0a0a); border-color: #401a1a; }
  .kpi-btn.cat-yellow { background: linear-gradient(145deg, #1a1500, #131000); border-color: #3a3000; }
  .kpi-btn.cat-orange { background: linear-gradient(145deg, #1a0f00, #140b00); border-color: #3a2000; }
  .kpi-btn.cat-purple { background: linear-gradient(145deg, #150d20, #100a1a); border-color: #301a40; }
  .kpi-btn.cat-blue   { background: linear-gradient(145deg, #0d1520, #0a1018); border-color: #1a2a40; }

  .kpi-label {
    font-size: 12px; font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.3px;
    text-align: center; line-height: 1.15; color: var(--text);
    order: 2; margin-top: 1px;
  }
  .kpi-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px; line-height: 1;
    order: 1; opacity: 0.85;
  }
  .cat-green  .kpi-count { color: #00e676; }
  .cat-red    .kpi-count { color: #ff3d5a; }
  .cat-yellow .kpi-count { color: #ffe082; }
  .cat-orange .kpi-count { color: #ffab40; }
  .cat-purple .kpi-count { color: #b388ff; }
  .cat-blue   .kpi-count { color: #00d4ff; }

  /* Q-BAR: mini per-quarter bar at bottom of each button */
  .kpi-qbar {
    order: 3;
    display: flex;
    width: 88%;
    height: 5px;
    margin-top: 4px;
    gap: 2px;
    border-radius: 3px;
  }
  .qbar-seg {
    flex: 1;
    height: 100%;
    border-radius: 2px;
    background: rgba(255,255,255,0.07);
    transition: background 0.25s, opacity 0.25s;
  }
  .cat-green  .qbar-seg.lit { background: rgba(0,230,118,0.65); }
  .cat-red    .qbar-seg.lit { background: rgba(255,61,90,0.65); }
  .cat-yellow .qbar-seg.lit { background: rgba(255,224,130,0.65); }
  .cat-orange .qbar-seg.lit { background: rgba(255,171,64,0.65); }
  .cat-purple .qbar-seg.lit { background: rgba(179,136,255,0.65); }
  .cat-blue   .qbar-seg.lit { background: rgba(0,212,255,0.65); }
  .qbar-seg.cur { box-shadow: 0 0 5px rgba(255,255,255,0.4); }

  /* Flash overlay */
  .kpi-btn::after {
    content: ''; position: absolute; inset: 0;
    background: var(--flash); opacity: 0;
    border-radius: inherit; pointer-events: none;
    transition: opacity 0.05s;
  }
  .kpi-btn.flashing::after { opacity: 0.35; }

  /* Ripple */
  .ripple {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: scale(0);
    animation: ripple-anim 0.45s ease-out forwards;
    pointer-events: none;
  }
  @keyframes ripple-anim {
    0%   { transform: scale(0); opacity: 1; }
    100% { transform: scale(4); opacity: 0; }
  }

  /* BOTTOM ROW */
  #bottom-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
    flex-shrink: 0;
  }
  .action-btn {
    padding: 11px 4px;
    border-radius: var(--radius-sm);
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.5px; text-transform: uppercase;
    cursor: pointer; border: 1.5px solid;
    transition: background 0.2s, border-color 0.2s, color 0.2s;
    text-align: center; line-height: 1.3;
  }
  .action-btn:active { opacity: 0.72; transform: scale(0.95); }
  #flow-btn { font-size: 10px; }
  #pause-btn { background: rgba(255,171,64,0.12); border-color: rgba(255,171,64,0.4); color: var(--amber); }
  #pause-btn.resuming { background: rgba(0,230,118,0.15); border-color: rgba(0,230,118,0.5); color: var(--green); }
  #pause-btn.disabled-btn { background: rgba(107,122,153,0.08); border-color: rgba(107,122,153,0.2); color: rgba(107,122,153,0.35); pointer-events: none; }
  #undo-btn    { background: rgba(255,61,90,0.12);   border-color: rgba(255,61,90,0.4);   color: var(--red);    }
  #display-btn { background: rgba(0,212,255,0.12);   border-color: rgba(0,212,255,0.4);   color: var(--accent); }
  #export-btn  { background: rgba(179,136,255,0.12); border-color: rgba(179,136,255,0.4); color: var(--purple); }
  #flow-btn.long-pressing { box-shadow: 0 0 0 3px rgba(255,61,90,0.6); }

  /* CONFIRM DIALOG */
  #confirm-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.88); z-index: 200;
    align-items: center; justify-content: center;
    padding: 24px; backdrop-filter: blur(8px);
  }
  #confirm-overlay.visible { display: flex; }
  #confirm-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 28px 24px;
    max-width: 360px; width: 100%; text-align: center;
  }
  #confirm-box h3 { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 2px; margin-bottom: 10px; }
  #confirm-box p { font-size: 14px; color: var(--text-dim); line-height: 1.5; margin-bottom: 22px; }
  .confirm-btns { display: flex; gap: 10px; }
  .confirm-btns button { flex: 1; padding: 14px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border: 1.5px solid; }
  #confirm-yes { background: var(--red); border-color: var(--red); color: #fff; }
  #confirm-yes.positive { background: var(--green); border-color: var(--green); color: #000; }
  #confirm-no  { background: var(--surface2); border-color: var(--border); color: var(--text); }

  /* STATS MODAL */
  #modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.85); z-index: 100;
    align-items: center; justify-content: center;
    padding: 12px; backdrop-filter: blur(6px);
  }
  #modal-overlay.visible { display: flex; }
  #modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; padding: 16px;
    width: 100%; max-width: 760px;
    max-height: 92vh; overflow-y: auto;
    display: flex; flex-direction: column; gap: 10px;
  }
  #modal-box h2 { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 2px; color: var(--accent); text-align: center; }
  #modal-score-summary { text-align: center; font-size: 13px; color: var(--text-dim); font-weight: 700; letter-spacing: 1px; }

  /* Tabs */
  #modal-tabs { display: flex; gap: 6px; flex-shrink: 0; }
  .modal-tab {
    flex: 1; padding: 9px 4px;
    background: var(--surface2); border: 1.5px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text-dim);
    font-size: 12px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; text-align: center; cursor: pointer;
    transition: all 0.2s;
  }
  .modal-tab.active { background: var(--accent); border-color: var(--accent); color: #000; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  #stats-table, #raw-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  #stats-table th, #raw-table th {
    background: var(--surface2); color: var(--text-dim);
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; padding: 10px 6px; text-align: center;
    border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 2;
  }
  #stats-table th:first-child, #raw-table th:first-child { text-align: left; }
  #stats-table td, #raw-table td {
    padding: 11px 6px; text-align: center;
    border-bottom: 1px solid rgba(30,45,69,0.5);
    font-weight: 600; color: var(--text);
  }
  #stats-table td:first-child, #raw-table td:first-child { text-align: left; color: var(--text-dim); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; }
  #stats-table td.target-col { color: var(--amber); font-size: 12px; font-weight: 700; }
  #stats-table td.total-col, #raw-table td.total-col { color: var(--accent); font-weight: 900; font-size: 16px; }
  #stats-table td.bad  { color: var(--red) !important; font-weight: 800; }
  #stats-table td.good { color: var(--green) !important; }
  #stats-table tr:last-child td, #raw-table tr:last-child td { border-bottom: none; }
  #stats-table tr:hover td, #raw-table tr:hover td { background: rgba(255,255,255,0.03); }

  /* Category headers in raw counts table */
  tr.cat-header td {
    background: rgba(255,255,255,0.04);
    color: var(--text-dim) !important;
    font-size: 10px !important; font-weight: 900 !important;
    letter-spacing: 2px !important; text-transform: uppercase !important;
    padding: 7px 6px !important; border-bottom: none !important;
  }

  #close-modal-btn {
    margin-top: 4px; width: 100%; padding: 15px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text);
    font-size: 15px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; cursor: pointer; flex-shrink: 0;
  }

  /* CSV overlay */
  #csv-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.88); z-index: 300;
    align-items: center; justify-content: center;
    padding: 24px; backdrop-filter: blur(8px);
  }
  #csv-overlay.visible { display: flex; }
  #csv-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 24px; max-width: 420px; width: 100%; text-align: center; }
  #csv-box h3 { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; color: var(--accent); margin-bottom: 8px; }
  #csv-box p { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; line-height: 1.5; }
  #csv-link { display: block; padding: 14px; background: rgba(179,136,255,0.15); border: 1.5px solid rgba(179,136,255,0.5); border-radius: var(--radius-sm); color: var(--purple); font-size: 14px; font-weight: 700; letter-spacing: 1px; text-decoration: none; text-transform: uppercase; margin-bottom: 10px; }
  #csv-close { width: 100%; padding: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); font-size: 13px; font-weight: 700; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; }

  /* Game over banner */
  #game-over-banner {
    display: none; position: fixed; top: 0; left: 0; right: 0;
    background: linear-gradient(90deg, #00e676, #00d4ff);
    color: #000; text-align: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; letter-spacing: 3px;
    padding: 10px; z-index: 50;
  }
  #game-over-banner.visible { display: block; }

  /* Toast */
  #toast {
    position: fixed; bottom: 72px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 30px; padding: 8px 20px;
    font-size: 13px; font-weight: 600; color: var(--text-dim);
    opacity: 0; transition: all 0.25s; z-index: 400; white-space: nowrap;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="game-over-banner">â¬› Full Time â¬›</div>

<div id="app">

  <!-- SCOREBOARD -->
  <div id="scoreboard">
    <div class="score-team">
      <div class="score-label">Us</div>
      <div class="score-block">
        <div class="score-value" id="score-us">0-00</div>
        <div class="score-total" id="score-us-pts">(0)</div>
      </div>
    </div>
    <div id="match-info">
      <div id="quarter-label">Pre-Match</div>
      <div id="clock-row">
        <button class="clock-adj minus disabled" id="clock-minus" onclick="adjustClock(-30)">âˆ’30s</button>
        <div id="match-clock">00:00</div>
        <button class="clock-adj plus disabled" id="clock-plus" onclick="adjustClock(+30)">+30s</button>
      </div>
      <div id="game-status">Long-press Flow to reset</div>
    </div>
    <div class="score-team">
      <div class="score-label">Them</div>
      <div class="score-block">
        <div class="score-total" id="score-them-pts">(0)</div>
        <div class="score-value" id="score-them">0-00</div>
      </div>
    </div>
  </div>

  <!-- QUARTER PILLS -->
  <div id="quarter-row">
    <div class="qtr-pill" data-q="1">Q1<span class="qtr-score" id="q1-score"></span></div>
    <div class="qtr-pill" data-q="2">Q2<span class="qtr-score" id="q2-score"></span></div>
    <div class="qtr-pill" data-q="3">Q3<span class="qtr-score" id="q3-score"></span></div>
    <div class="qtr-pill" data-q="4">Q4<span class="qtr-score" id="q4-score"></span></div>
  </div>

  <!-- KPI GRID 4Ã—5 -->
  <div id="kpi-grid">
    <button class="kpi-btn cat-green"  data-kpi="Point â€“ Play (Us)"        onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Point â€“ Play (Us)</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-yellow" data-kpi="Shot Miss â€“ Play"    onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Shot Miss â€“ Play</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-green"  data-kpi="Point â€“ Free (Us)"     onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Point â€“ Free (Us)</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-yellow" data-kpi="Shot Miss â€“ Free" onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Shot Miss â€“ Free</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>

    <button class="kpi-btn cat-red"    data-kpi="Point â€“ Them"       onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Point â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-orange" data-kpi="Shot Miss â€“ Them"        onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Shot Miss â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-red"    data-kpi="Goal â€“ Them"        onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Goal â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-green"  data-kpi="Goal â€“ Us"           onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Goal â€“ Us</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>

    <button class="kpi-btn cat-purple" data-kpi="PO Win â€“ Us"        onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">PO Win â€“ Us</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-red"    data-kpi="PO Lost â€“ Us"       onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">PO Lost â€“ Us</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-blue"   data-kpi="PO Win â€“ Them"      onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">PO Win â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-blue"   data-kpi="PO Lost â€“ Them"     onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">PO Lost â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>

    <button class="kpi-btn cat-purple" data-kpi="Turnover â€“ Forced"    onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">T/O â€“ Forced</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-purple" data-kpi="Contest Win"       onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Contest Win</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-red"    data-kpi="Contest Lost"      onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Contest Lost</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-purple" data-kpi="Turnover â€“ Us"   onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">T/O â€“ Us</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>

    <button class="kpi-btn cat-purple" data-kpi="Free Won â€“ Us"           onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Free Won â€“ Us</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-red"    data-kpi="Free Won â€“ Them"          onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Free Won â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-yellow" data-kpi="Run thru 65"         onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">Run thru 65</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
    <button class="kpi-btn cat-red"    data-kpi="Turnover â€“ Them"         onclick="logEvent(this,event)"><span class="kpi-count">0</span><span class="kpi-label">T/O â€“ Them</span><span class="kpi-qbar"><span class="qbar-seg" data-q="1"></span><span class="qbar-seg" data-q="2"></span><span class="qbar-seg" data-q="3"></span><span class="qbar-seg" data-q="4"></span></span></button>
  </div>

  <!-- BOTTOM ROW -->
  <div id="bottom-row">
    <button class="action-btn" id="flow-btn"    onclick="advanceGameFlow()">â–¶ Start Game</button>
    <button class="action-btn" id="pause-btn"   onclick="togglePause()">â¸ Pause</button>
    <button class="action-btn" id="undo-btn"    onclick="undoLast()">â†© Undo</button>
    <button class="action-btn" id="display-btn" onclick="showDisplay()">ğŸ“Š Stats</button>
    <button class="action-btn" id="export-btn"  onclick="exportCSV()">â¬‡ CSV</button>
  </div>

</div>

<!-- CONFIRM DIALOG -->
<div id="confirm-overlay">
  <div id="confirm-box">
    <h3 id="confirm-title">Are you sure?</h3>
    <p id="confirm-msg">This action cannot be undone.</p>
    <div class="confirm-btns">
      <button id="confirm-yes" onclick="confirmAction()">Confirm</button>
      <button id="confirm-no"  onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- STATS MODAL -->
<div id="modal-overlay" onclick="hideDisplay(event)">
  <div id="modal-box">
    <h2>Match Statistics</h2>
    <div id="modal-score-summary"></div>
    <div id="modal-tabs">
      <div class="modal-tab active" data-tab="kpi" onclick="switchTab('kpi')">ğŸ“ˆ KPI Dashboard</div>
      <div class="modal-tab"        data-tab="raw" onclick="switchTab('raw')">ğŸ“‹ Raw Counts</div>
    </div>
    <div class="tab-content active" id="tab-kpi">
      <table id="stats-table">
        <thead>
          <tr><th>KPI Metric</th><th>Target</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Total</th></tr>
        </thead>
        <tbody id="stats-tbody"></tbody>
      </table>
    </div>
    <div class="tab-content" id="tab-raw">
      <table id="raw-table">
        <thead>
          <tr><th>Event</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Total</th></tr>
        </thead>
        <tbody id="raw-tbody"></tbody>
      </table>
    </div>
    <button id="close-modal-btn" onclick="hideDisplay()">Close</button>
  </div>
</div>

<!-- CSV FALLBACK (Safari) -->
<div id="csv-overlay">
  <div id="csv-box">
    <h3>ğŸ“¥ Export CSV</h3>
    <p>Tap the link below, then use Share â†’ Save to Files.</p>
    <a id="csv-link" href="#">Download CSV</a>
    <button id="csv-close" onclick="closeCsvOverlay()">Close</button>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KPI_LIST = [
  'Point â€“ Play (Us)','Shot Miss â€“ Play','Point â€“ Free (Us)','Shot Miss â€“ Free',
  'Point â€“ Them','Shot Miss â€“ Them','Goal â€“ Them','Goal â€“ Us',
  'PO Win â€“ Us','PO Lost â€“ Us','PO Win â€“ Them','PO Lost â€“ Them',
  'Turnover â€“ Forced','Contest Win','Contest Lost','Turnover â€“ Us',
  'Free Won â€“ Us','Free Won â€“ Them','Run thru 65','Turnover â€“ Them'
];

const KPI_GROUPS = [
  { label: 'â¬¢ Scoring â€” Us',       kpis: ['Point â€“ Play (Us)','Shot Miss â€“ Play','Point â€“ Free (Us)','Shot Miss â€“ Free','Goal â€“ Us'] },
  { label: 'â¬¢ Scoring â€” Them',     kpis: ['Point â€“ Them','Shot Miss â€“ Them','Goal â€“ Them'] },
  { label: 'â¬¢ Puckouts â€” Us',      kpis: ['PO Win â€“ Us','PO Lost â€“ Us'] },
  { label: 'â¬¢ Puckouts â€” Them',    kpis: ['PO Win â€“ Them','PO Lost â€“ Them'] },
  { label: 'â¬¢ Possession',         kpis: ['Turnover â€“ Forced','Turnover â€“ Us','Turnover â€“ Them','Contest Win','Contest Lost'] },
  { label: 'â¬¢ Frees & Discipline', kpis: ['Free Won â€“ Us','Free Won â€“ Them','Run thru 65'] },
];

const STORAGE_KEY = 'gaa_event_log_v8';
const STATE_KEY   = 'gaa_game_state_v8';
const Q1_Q2   = 15 * 60;
const H_START = 30 * 60;
const Q3_Q4   = 45 * 60;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let eventLog = [];
let state = {
  gameFlow: 'pre',
  firstHalfStart: null, firstHalfEnd: null, firstHalfPausedMs: 0,
  secondHalfStart: null, secondHalfEnd: null, secondHalfPausedMs: 0,
  pausedAt: null,
};
let clockInterval = null;
let pendingAction = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const savedLog   = localStorage.getItem(STORAGE_KEY);
  const savedState = localStorage.getItem(STATE_KEY);
  if (savedLog)   eventLog = JSON.parse(savedLog);
  if (savedState) state    = JSON.parse(savedState);
  refreshAll();
  clockInterval = setInterval(refreshClockDisplay, 500);
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
  setupFlowLongPress();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TIMING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMatchSeconds(atMs) {
  const now = atMs !== undefined ? atMs : Date.now();
  if (state.gameFlow === 'pre') return 0;

  let fhEnd = state.firstHalfEnd || now;
  if (state.gameFlow === 'first_half' && state.pausedAt) fhEnd = state.pausedAt;
  const fhSecs = state.firstHalfStart
    ? Math.max(0, Math.floor((fhEnd - state.firstHalfStart - state.firstHalfPausedMs) / 1000)) : 0;
  if (state.gameFlow === 'first_half' || state.gameFlow === 'half_time') return fhSecs;

  let shEnd = state.secondHalfEnd || now;
  if (state.gameFlow === 'second_half' && state.pausedAt) shEnd = state.pausedAt;
  const shSecs = state.secondHalfStart
    ? Math.max(0, Math.floor((shEnd - state.secondHalfStart - state.secondHalfPausedMs) / 1000)) : 0;
  return H_START + shSecs;
}

function getQuarterFromSeconds(secs) {
  if (secs < Q1_Q2)   return 1;
  if (secs < H_START) return 2;
  if (secs < Q3_Q4)   return 3;
  return 4;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME FLOW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function advanceGameFlow() {
  switch (state.gameFlow) {
    case 'pre':         doStartGame();       break;
    case 'first_half':  doEndFirstHalf();    break;
    case 'half_time':   doStartSecondHalf(); break;
    case 'second_half': confirmEndGame();    break;
    case 'ended': showToast('Full Time â€” long-press â–¶ to start a new game'); break;
  }
}

function doStartGame() {
  Object.assign(state, {
    gameFlow: 'first_half',
    firstHalfStart: Date.now(), firstHalfEnd: null, firstHalfPausedMs: 0,
    secondHalfStart: null, secondHalfEnd: null, secondHalfPausedMs: 0,
    pausedAt: null,
  });
  saveState(); refreshAll(); showToast('ğŸ Kick off â€” 1st Half');
}

function doEndFirstHalf() {
  if (state.pausedAt) { state.firstHalfPausedMs += Date.now() - state.pausedAt; state.pausedAt = null; }
  state.gameFlow = 'half_time'; state.firstHalfEnd = Date.now();
  saveState(); refreshAll(); showToast('â¸ Half Time');
}

function doStartSecondHalf() {
  Object.assign(state, { gameFlow: 'second_half', secondHalfStart: Date.now(), secondHalfEnd: null, secondHalfPausedMs: 0, pausedAt: null });
  saveState(); refreshAll(); showToast('â–¶ 2nd Half â€” clock at 30:00');
}

function doEndGame() {
  if (state.pausedAt) { state.secondHalfPausedMs += Date.now() - state.pausedAt; state.pausedAt = null; }
  state.gameFlow = 'ended'; state.secondHalfEnd = Date.now();
  saveState();
  document.getElementById('game-over-banner').classList.add('visible');
  refreshAll(); showToast('â¹ Full Time');
}

function togglePause() {
  if (state.gameFlow !== 'first_half' && state.gameFlow !== 'second_half') {
    showToast('Pause only available during active half'); return;
  }
  if (state.pausedAt !== null) {
    const dur = Date.now() - state.pausedAt;
    if (state.gameFlow === 'first_half') state.firstHalfPausedMs += dur;
    else state.secondHalfPausedMs += dur;
    state.pausedAt = null;
    saveState(); refreshAll(); showToast('â–¶ Resumed');
  } else {
    state.pausedAt = Date.now();
    saveState(); refreshAll(); showToast('â¸ Game paused');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LONG PRESS â†’ New Game
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lpTimer = null;

function setupFlowLongPress() {
  const btn = document.getElementById('flow-btn');
  const start = () => { btn.classList.add('long-pressing'); lpTimer = setTimeout(() => { btn.classList.remove('long-pressing'); confirmNewGame(); }, 800); };
  const cancel = () => { clearTimeout(lpTimer); btn.classList.remove('long-pressing'); };
  btn.addEventListener('touchstart', start, { passive: true });
  btn.addEventListener('touchend', cancel, { passive: true });
  btn.addEventListener('touchcancel', cancel, { passive: true });
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', cancel);
  btn.addEventListener('mouseleave', cancel);
}

function confirmNewGame() {
  showConfirm('âŠ• New Game', 'Clear all match data and start fresh?', doNewGame, false);
}
function doNewGame() {
  eventLog = [];
  state = { gameFlow: 'pre', firstHalfStart: null, firstHalfEnd: null, firstHalfPausedMs: 0, secondHalfStart: null, secondHalfEnd: null, secondHalfPausedMs: 0, pausedAt: null };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));
  saveState();
  document.getElementById('game-over-banner').classList.remove('visible');
  refreshAll(); showToast('New game ready â€” tap â–¶ Start Game');
}

function confirmEndGame() {
  showConfirm('â¹ End Game', 'Mark match as finished? Stats & CSV still available.', doEndGame, true);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIRM DIALOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(title, msg, action, isPositive) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent   = msg;
  document.getElementById('confirm-yes').className = isPositive ? 'positive' : '';
  pendingAction = action;
  document.getElementById('confirm-overlay').classList.add('visible');
}
function confirmAction() { closeConfirm(); if (pendingAction) { pendingAction(); pendingAction = null; } }
function closeConfirm() { document.getElementById('confirm-overlay').classList.remove('visible'); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LOGGING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logEvent(btn, evt) {
  if (state.pausedAt !== null)        { showToast('Game is paused â€” tap â–¶ Resume first'); return; }
  if (state.gameFlow === 'half_time') { showToast('Half Time â€” tap â–¶ 2nd Half to continue'); return; }
  if (state.gameFlow === 'ended')     { showToast('Game has ended'); return; }
  if (state.gameFlow === 'pre')       doStartGame();

  const kpi = btn.dataset.kpi;
  const now = Date.now();
  const secs = getMatchSeconds(now);
  const quarter = getQuarterFromSeconds(secs);
  const m = Math.floor(secs / 60).toString().padStart(2,'0');
  const s = (secs % 60).toString().padStart(2,'0');

  eventLog.push({ kpi, ts: now, quarter, time: `Q${quarter} ${m}:${s}` });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));

  triggerFlash(btn); triggerRipple(btn, evt); triggerScale(btn);
  refreshCounts(); refreshScoreboard(); refreshQBars();
}

function undoLast() {
  if (eventLog.length === 0) { showToast('Nothing to undo'); return; }
  const last = eventLog.pop();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));
  showToast(`â†© Undid: ${last.kpi} @ ${last.time}`);
  refreshCounts(); refreshScoreboard(); refreshQBars();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOCK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOCK ADJUST  Â±30 seconds
// Shifts the relevant half's start time so the running clock moves forward or
// back by the requested amount. Works while live OR paused.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adjustClock(deltaSecs) {
  const active = state.gameFlow === 'first_half' || state.gameFlow === 'second_half';
  const paused = state.gameFlow === 'half_time';  // half_time clock is frozen at firstHalfEnd
  if (!active && !paused) return;

  const deltaMs = deltaSecs * 1000;

  if (state.gameFlow === 'first_half') {
    // Shift start earlier (deltaMs<0) to add time, or later (deltaMs>0) to subtract
    state.firstHalfStart -= deltaMs;
    // Don't let clock go below 0
    const secs = getMatchSeconds();
    if (secs < 0) state.firstHalfStart += deltaMs; // revert if it would go negative

  } else if (state.gameFlow === 'half_time') {
    // Adjust the frozen first-half end point
    state.firstHalfEnd = (state.firstHalfEnd || Date.now()) + deltaMs;
    const secs = getMatchSeconds();
    if (secs < 0) state.firstHalfEnd -= deltaMs;

  } else if (state.gameFlow === 'second_half') {
    state.secondHalfStart -= deltaMs;
    const secs = getMatchSeconds();
    if (secs < H_START) state.secondHalfStart += deltaMs;
  }

  saveState();
  refreshClockDisplay();
  refreshQBars();
  const dir = deltaSecs > 0 ? `+${deltaSecs}s` : `${deltaSecs}s`;
  showToast(`Clock adjusted ${dir} â†’ ${document.getElementById('match-clock').textContent}`);
}

function refreshClockDisplay() {
  const clockEl  = document.getElementById('match-clock');
  const statusEl = document.getElementById('game-status');
  const qlEl     = document.getElementById('quarter-label');
  const isPaused = state.pausedAt !== null;

  // Enable/disable adj buttons
  const canAdj = state.gameFlow === 'first_half' || state.gameFlow === 'second_half' || state.gameFlow === 'half_time';
  document.getElementById('clock-minus').classList.toggle('disabled', !canAdj);
  document.getElementById('clock-plus').classList.toggle('disabled', !canAdj);

  if (state.gameFlow === 'pre') {
    clockEl.textContent = '00:00'; clockEl.classList.remove('paused');
    statusEl.textContent = 'Long-press Flow to reset'; qlEl.textContent = 'Pre-Match';
    updateQtrPills(0); return;
  }

  const secs = getMatchSeconds();
  const m = Math.floor(secs / 60).toString().padStart(2,'0');
  const s = (secs % 60).toString().padStart(2,'0');
  clockEl.textContent = `${m}:${s}`;

  if (state.gameFlow === 'half_time') {
    clockEl.classList.add('paused'); statusEl.textContent = 'Half Time'; qlEl.textContent = 'Half Time';
    updateQtrPills(secs); return;
  }
  if (state.gameFlow === 'ended') {
    clockEl.classList.remove('paused'); statusEl.textContent = 'Full Time'; qlEl.textContent = 'Full Time';
    updateQtrPills(secs); return;
  }

  if (isPaused) { clockEl.classList.add('paused'); statusEl.textContent = 'Paused'; }
  else          { clockEl.classList.remove('paused'); statusEl.textContent = 'Live'; }
  qlEl.textContent = `Quarter ${getQuarterFromSeconds(secs)}`;
  updateQtrPills(secs);
}

function updateQtrPills(secs) {
  const isPre = state.gameFlow === 'pre';
  const curQ  = isPre ? 0 : getQuarterFromSeconds(secs);

  for (let q = 1; q <= 4; q++) {
    const pill = document.querySelector(`.qtr-pill[data-q="${q}"]`);
    const scoreEl = document.getElementById(`q${q}-score`);
    pill.classList.toggle('active', q === curQ && !isPre);
    pill.classList.toggle('done',   q < curQ);

    // Cumulative score up to this quarter
    const gf = eventLog.filter(e => e.kpi === 'Goal â€“ Us' && e.quarter === q).length;
    const pf = eventLog.filter(e => (e.kpi === 'Point â€“ Play (Us)' || e.kpi === 'Point â€“ Free (Us)') && e.quarter === q).length;
    const ga = eventLog.filter(e => e.kpi === 'Goal â€“ Them' && e.quarter === q).length;
    const pa = eventLog.filter(e => e.kpi === 'Point â€“ Them' && e.quarter === q).length;
    const u = gf*3+pf, t = ga*3+pa;
    scoreEl.textContent = (u > 0 || t > 0) ? `${u}-${t}` : '';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Q-BARS on each KPI button
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshQBars() {
  const counts = {};
  KPI_LIST.forEach(k => { counts[k] = {1:0,2:0,3:0,4:0}; });
  eventLog.forEach(e => { if (counts[e.kpi]) counts[e.kpi][e.quarter]++; });

  const curQ = state.gameFlow === 'pre' ? 0 : getQuarterFromSeconds(getMatchSeconds());

  document.querySelectorAll('.kpi-btn').forEach(btn => {
    const kpi = btn.dataset.kpi;
    const c = counts[kpi];
    const maxVal = Math.max(c[1], c[2], c[3], c[4], 1);
    btn.querySelectorAll('.qbar-seg').forEach(seg => {
      const q = parseInt(seg.dataset.q);
      const hasData = c[q] > 0;
      seg.classList.toggle('lit', hasData);
      seg.classList.toggle('cur', q === curQ);
      seg.style.opacity = hasData ? String(0.35 + (c[q] / maxVal) * 0.65) : '';
    });
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REFRESH ALL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll() {
  refreshCounts(); refreshScoreboard(); refreshFlowBtn(); refreshPauseBtn();
  refreshClockDisplay(); refreshQBars();
}

function refreshFlowBtn() {
  const btn = document.getElementById('flow-btn');
  const map = {
    pre:         { label: 'â–¶ Start Game',   bg: 'rgba(0,230,118,0.15)',   bc: 'rgba(0,230,118,0.5)',   c: 'var(--green)'    },
    first_half:  { label: 'â¸ End 1st Half', bg: 'rgba(255,171,64,0.15)',  bc: 'rgba(255,171,64,0.5)',  c: 'var(--amber)'    },
    half_time:   { label: 'â–¶ 2nd Half',     bg: 'rgba(0,212,255,0.15)',   bc: 'rgba(0,212,255,0.5)',   c: 'var(--accent)'   },
    second_half: { label: 'â¹ End Game',     bg: 'rgba(255,61,90,0.15)',   bc: 'rgba(255,61,90,0.5)',   c: 'var(--red)'      },
    ended:       { label: 'â€” Full Time',    bg: 'rgba(107,122,153,0.10)', bc: 'rgba(107,122,153,0.3)', c: 'var(--text-dim)' },
  };
  const s = map[state.gameFlow] || map.pre;
  btn.textContent = s.label; btn.style.background = s.bg; btn.style.borderColor = s.bc; btn.style.color = s.c;
}

function refreshPauseBtn() {
  const btn = document.getElementById('pause-btn');
  const canPause = state.gameFlow === 'first_half' || state.gameFlow === 'second_half';
  if (!canPause) { btn.className = 'action-btn disabled-btn'; btn.textContent = 'â¸ Pause'; return; }
  if (state.pausedAt !== null) { btn.className = 'action-btn resuming'; btn.textContent = 'â–¶ Resume'; }
  else {
    btn.className = 'action-btn';
    btn.style.background = 'rgba(255,171,64,0.12)'; btn.style.borderColor = 'rgba(255,171,64,0.4)'; btn.style.color = 'var(--amber)';
    btn.textContent = 'â¸ Pause';
  }
}

function refreshCounts() {
  const counts = {};
  KPI_LIST.forEach(k => counts[k] = 0);
  eventLog.forEach(e => { if (counts[e.kpi] !== undefined) counts[e.kpi]++; });
  document.querySelectorAll('.kpi-btn').forEach(btn => {
    btn.querySelector('.kpi-count').textContent = counts[btn.dataset.kpi] ?? 0;
  });
}

function refreshScoreboard() {
  const gf = eventLog.filter(e => e.kpi === 'Goal â€“ Us').length;
  const pf = eventLog.filter(e => e.kpi === 'Point â€“ Play (Us)' || e.kpi === 'Point â€“ Free (Us)').length;
  const ga = eventLog.filter(e => e.kpi === 'Goal â€“ Them').length;
  const pa = eventLog.filter(e => e.kpi === 'Point â€“ Them').length;

  const usEl = document.getElementById('score-us');
  const usPts = document.getElementById('score-us-pts');
  const themEl = document.getElementById('score-them');
  const themPts = document.getElementById('score-them-pts');

  const newUs = `${gf}-${pf.toString().padStart(2,'0')}`;
  const newThem = `${ga}-${pa.toString().padStart(2,'0')}`;
  if (usEl.textContent !== newUs)     { usEl.textContent = newUs;     flashEl(usEl); }
  if (themEl.textContent !== newThem) { themEl.textContent = newThem; flashEl(themEl); }
  usPts.textContent   = `(${gf*3+pf})`;
  themPts.textContent = `(${ga*3+pa})`;
}

function flashEl(el) { el.classList.add('flash-score'); setTimeout(() => el.classList.remove('flash-score'), 400); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANIMATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerFlash(btn) { btn.classList.add('flashing'); setTimeout(() => btn.classList.remove('flashing'), 200); }

function triggerRipple(btn, evt) {
  const rect = btn.getBoundingClientRect();
  const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
  const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
  const size = Math.max(rect.width, rect.height);
  const r = document.createElement('span');
  r.className = 'ripple';
  r.style.cssText = `width:${size}px;height:${size}px;left:${x-size/2}px;top:${y-size/2}px`;
  btn.appendChild(r);
  setTimeout(() => r.remove(), 500);
}

function triggerScale(btn) {
  btn.style.transform = 'scale(0.90)';
  setTimeout(() => { btn.style.transform = 'scale(1.04)'; }, 100);
  setTimeout(() => { btn.style.transform = ''; }, 220);
  if (navigator.vibrate) navigator.vibrate(18);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === `tab-${tab}`));
}

function showDisplay() {
  const raw = {};
  KPI_LIST.forEach(k => { raw[k] = {1:0,2:0,3:0,4:0}; });
  eventLog.forEach(e => { if (raw[e.kpi]) raw[e.kpi][e.quarter]++; });
  const c   = (kpi, q) => (raw[kpi] ? raw[kpi][q] : 0);
  const pct = (num, den) => den === 0 ? '--' : Math.round((num / den) * 100) + '%';

  const maxPlayedQ = (() => {
    if (state.gameFlow === 'pre')      return 0;
    if (state.gameFlow === 'ended')    return 4;
    if (state.gameFlow === 'half_time') return 2;
    return getQuarterFromSeconds(getMatchSeconds());
  })();

  function cell(display, isBad, q, isTotal = false) {
    let cls = isTotal ? 'total-col' : (q <= maxPlayedQ ? (isBad ? 'bad' : 'good') : '');
    return `<td class="${cls}">${display}</td>`;
  }

  // KPI Dashboard rows
  const rows = [
    { label: 'Our Scores',             target: 'â‰¥5/qtr',
      qval: q => c('Point â€“ Play (Us)',q) + c('Point â€“ Free (Us)',q) + c('Goal â€“ Us',q),
      total: () => [1,2,3,4].reduce((s,q) => s + c('Point â€“ Play (Us)',q) + c('Point â€“ Free (Us)',q) + c('Goal â€“ Us',q), 0),
      bad: v => v < 5 },
    { label: 'Their Scores',           target: 'â‰¤4/qtr',
      qval: q => c('Point â€“ Them',q) + c('Goal â€“ Them',q),
      total: () => [1,2,3,4].reduce((s,q) => s + c('Point â€“ Them',q) + c('Goal â€“ Them',q), 0),
      bad: v => v > 4 },
    { label: 'Shot Efficiency (Play)', target: 'â‰¥70%',  isPct: true,
      qval: q => ({ n: c('Point â€“ Play (Us)',q), d: c('Point â€“ Play (Us)',q) + c('Shot Miss â€“ Play',q) }),
      bad: (n,d) => d > 0 && n/d < 0.70 },
    { label: 'Shot Efficiency (Free)', target: 'â‰¥80%',  isPct: true,
      qval: q => ({ n: c('Point â€“ Free (Us)',q), d: c('Point â€“ Free (Us)',q) + c('Shot Miss â€“ Free',q) }),
      bad: (n,d) => d > 0 && n/d < 0.80 },
    { label: 'Total Shot Efficiency',  target: 'â‰¥75%',  isPct: true,
      qval: q => { const n = c('Point â€“ Play (Us)',q)+c('Point â€“ Free (Us)',q); const d = n+c('Shot Miss â€“ Play',q)+c('Shot Miss â€“ Free',q); return {n,d}; },
      bad: (n,d) => d > 0 && n/d < 0.75 },
    { label: 'Forced Turnovers',       target: 'â‰¥2/qtr',
      qval: q => c('Turnover â€“ Forced',q),
      total: () => [1,2,3,4].reduce((s,q) => s + c('Turnover â€“ Forced',q), 0),
      bad: v => v < 2 },
    { label: 'Puckout Retention (Us)', target: 'â‰¥70%',  isPct: true,
      qval: q => ({ n: c('PO Win â€“ Us',q), d: c('PO Win â€“ Us',q)+c('PO Lost â€“ Us',q) }),
      bad: (n,d) => d > 0 && n/d < 0.70 },
    { label: 'Puckout Success (Opp)',  target: 'â‰¤50%',  isPct: true,
      qval: q => ({ n: c('PO Win â€“ Them',q), d: c('PO Win â€“ Them',q)+c('PO Lost â€“ Them',q) }),
      bad: (n,d) => d > 0 && n/d > 0.50 },
    { label: 'Breaking Ball Success',  target: 'â‰¥51%',  isPct: true,
      qval: q => ({ n: c('Contest Win',q), d: c('Contest Win',q)+c('Contest Lost',q) }),
      bad: (n,d) => d > 0 && n/d < 0.51 },
    { label: 'UnContested Loss Ratio', target: 'â‰¤49%',  isPct: true,
      qval: q => ({ n: c('Turnover â€“ Us',q), d: c('Turnover â€“ Us',q)+c('Turnover â€“ Them',q) }),
      bad: (n,d) => d > 0 && n/d > 0.49 },
    { label: 'Run thru 65',            target: 'â‰¥7 total',
      qval: q => c('Run thru 65',q),
      total: () => [1,2,3,4].reduce((s,q) => s + c('Run thru 65',q), 0),
      bad: v => v < 7 },
  ];

  const tbody = document.getElementById('stats-tbody');
  tbody.innerHTML = '';
  rows.forEach(row => {
    const tr = document.createElement('tr');
    let html = `<td>${row.label}</td><td class="target-col">${row.target}</td>`;
    if (row.isPct) {
      let tN = 0, tD = 0;
      [1,2,3,4].forEach(q => { const {n,d} = row.qval(q); tN+=n; tD+=d; html += cell(pct(n,d), row.bad(n,d), q); });
      html += `<td class="total-col">${pct(tN,tD)}</td>`;
    } else {
      let total = 0;
      [1,2,3,4].forEach(q => { const v = row.qval(q); total+=v; html += cell(v, row.bad(v), q); });
      html += `<td class="total-col">${row.total ? row.total() : total}</td>`;
    }
    tr.innerHTML = html;
    tbody.appendChild(tr);
  });

  // Raw Counts tab
  const rawTbody = document.getElementById('raw-tbody');
  rawTbody.innerHTML = '';
  KPI_GROUPS.forEach(group => {
    const htr = document.createElement('tr');
    htr.className = 'cat-header';
    htr.innerHTML = `<td colspan="6">${group.label}</td>`;
    rawTbody.appendChild(htr);
    group.kpis.forEach(kpi => {
      const total = [1,2,3,4].reduce((s,q) => s+c(kpi,q), 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${kpi}</td><td>${c(kpi,1)}</td><td>${c(kpi,2)}</td><td>${c(kpi,3)}</td><td>${c(kpi,4)}</td><td class="total-col">${total}</td>`;
      rawTbody.appendChild(tr);
    });
  });

  const gf = eventLog.filter(e=>e.kpi==='Goal â€“ Us').length;
  const pf = eventLog.filter(e=>e.kpi==='Point â€“ Play (Us)'||e.kpi==='Point â€“ Free (Us)').length;
  const ga = eventLog.filter(e=>e.kpi==='Goal â€“ Them').length;
  const pa = eventLog.filter(e=>e.kpi==='Point â€“ Them').length;
  document.getElementById('modal-score-summary').textContent =
    `Us ${gf}-${pf.toString().padStart(2,'0')} (${gf*3+pf})  vs  Them ${ga}-${pa.toString().padStart(2,'0')} (${ga*3+pa})`;

  document.getElementById('modal-overlay').classList.add('visible');
}

function hideDisplay(evt) {
  if (evt && evt.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('visible');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  if (eventLog.length === 0) { showToast('No events logged yet'); return; }
  const lines = ['Event,Quarter,MatchTime,Timestamp_ms'];
  eventLog.forEach(e => lines.push(`"${e.kpi}",${e.quarter},"${e.time}",${e.ts}`));
  lines.push('','KPI Summary','KPI,Qtr1,Qtr2,Qtr3,Qtr4,Total');
  const data = {};
  KPI_LIST.forEach(k => { data[k] = {1:0,2:0,3:0,4:0}; });
  eventLog.forEach(e => { if (data[e.kpi]) data[e.kpi][e.quarter]++; });
  KPI_LIST.forEach(k => {
    const t = data[k][1]+data[k][2]+data[k][3]+data[k][4];
    lines.push(`"${k}",${data[k][1]},${data[k][2]},${data[k][3]},${data[k][4]},${t}`);
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const fn   = `gaa_stats_${new Date().toISOString().slice(0,16).replace('T','_').replace(':','-')}.csv`;
  const a = document.createElement('a');
  a.href = url; a.download = fn;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => {
    if (typeof a.download === 'undefined' || /iPad|iPhone/.test(navigator.userAgent)) showCsvOverlay(url, fn);
    else { URL.revokeObjectURL(url); showToast('CSV downloaded âœ“'); }
  }, 300);
}

let csvBlobUrl = null;
function showCsvOverlay(url, fn) {
  if (csvBlobUrl) URL.revokeObjectURL(csvBlobUrl);
  csvBlobUrl = url;
  const link = document.getElementById('csv-link');
  link.href = url; link.download = fn; link.textContent = `ğŸ“„ ${fn}`;
  document.getElementById('csv-overlay').classList.add('visible');
}
function closeCsvOverlay() {
  document.getElementById('csv-overlay').classList.remove('visible');
  if (csvBlobUrl) { URL.revokeObjectURL(csvBlobUrl); csvBlobUrl = null; }
  showToast('CSV ready â€” use Share â†’ Save to Files');
}

function saveState() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

init();
</script>
</body>
</html>
