<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GAA Stats">
<title>GAA Hurling Stats</title>

<!--
  GAA HURLING STATS PWA v5
  ========================
  Fully offline Progressive Web App for hurling match statistics.
  iPad Mini (2021), Safari, Add to Home Screen.

  BOTTOM ROW (5 buttons):
    [Flow]  [Pause/Resume]  [Undo]  [Stats]  [CSV]

  FLOW BUTTON (tap to advance, long-press 800ms for New Game):
    State 1 "â–¶ Start Game"   â†’ starts clock from 0:00
    State 2 "â¸ End 1st Half" â†’ freezes clock at half-time
    State 3 "â–¶ 2nd Half"     â†’ clock resumes from 30:00
    State 4 "â¹ End Game"     â†’ confirm dialog â†’ full time

  PAUSE/RESUME BUTTON:
    Active during first_half and second_half only.
    Accumulates paused milliseconds so they are excluded from
    the clock and quarter calculations.

  QUARTER DETECTION (automatic, time-based, pauses excluded):
    Q1  0:00â€“14:59    Q2 15:00â€“end of 1st half
    Q3 30:00â€“44:59   Q4 45:00â€“end of 2nd half

  Quarter pills are VISUAL ONLY â€” no tap interaction.

  CSV EXPORT works at any game state including after game over.
-->

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;900&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --text: #e8eef8;
    --text-dim: #6b7a99;
    --accent: #00d4ff;
    --green: #00e676;
    --red: #ff3d5a;
    --amber: #ffab40;
    --purple: #b388ff;
    --flash: #00ff88;
    --radius: 14px;
    --radius-sm: 9px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }

  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 8px 8px 6px;
    gap: 6px;
  }

  /* â”€â”€ SCOREBOARD â”€â”€ */
  #scoreboard {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .score-team { display: flex; flex-direction: column; align-items: center; gap: 1px; }

  .score-label {
    font-size: 9px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; color: var(--text-dim);
  }

  .score-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px; line-height: 1; letter-spacing: 2px;
    color: var(--text); transition: color 0.2s;
  }
  .score-value.flash-score { color: var(--flash); }

  #match-info { display: flex; flex-direction: column; align-items: center; gap: 2px; }

  #quarter-label {
    font-size: 10px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; color: var(--accent);
  }

  #match-clock {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px; color: var(--text); letter-spacing: 1px;
    transition: color 0.2s;
  }
  #match-clock.paused  { color: var(--amber); }

  #game-status {
    font-size: 9px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--text-dim);
  }

  /* â”€â”€ QUARTER INDICATOR PILLS (visual only) â”€â”€ */
  #quarter-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
    flex-shrink: 0;
  }

  .qtr-pill {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-dim);
    font-size: 12px; font-weight: 700;
    letter-spacing: 1px; padding: 9px 4px;
    text-transform: uppercase;
    text-align: center;
    pointer-events: none;
    transition: background 0.3s, border-color 0.3s, color 0.3s, box-shadow 0.3s;
  }
  .qtr-pill.active {
    background: var(--accent); border-color: var(--accent);
    color: #000; box-shadow: 0 0 14px rgba(0,212,255,0.4);
  }
  .qtr-pill.done {
    border-color: rgba(0,212,255,0.3);
    color: rgba(0,212,255,0.5);
  }

  /* â”€â”€ KPI GRID â”€â”€ */
  #kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 6px;
    flex: 1;
    min-height: 0;
  }

  .kpi-btn {
    position: relative; overflow: hidden;
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 3px; padding: 6px 4px;
    transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    -webkit-tap-highlight-color: transparent;
  }

  .kpi-btn.cat-for     { background: linear-gradient(145deg, #0d2010, #0a1a0d); border-color: #1a4020; }
  .kpi-btn.cat-against { background: linear-gradient(145deg, #200d0d, #1a0a0a); border-color: #401a1a; }
  .kpi-btn.cat-puck    { background: linear-gradient(145deg, #0d1520, #0a1018); border-color: #1a2a40; }
  .kpi-btn.cat-contest { background: linear-gradient(145deg, #18110d, #130d08); border-color: #3a2a10; }
  .kpi-btn.cat-free    { background: linear-gradient(145deg, #150d20, #100a1a); border-color: #301a40; }
  .kpi-btn.cat-misc    { background: linear-gradient(145deg, #101018, #0a0a14); border-color: #202040; }

  .kpi-label {
    font-size: 12px; font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.3px;
    text-align: center; line-height: 1.2; color: var(--text);
    order: 2;
  }
  .kpi-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px; line-height: 1;
    order: 1;
    opacity: 0.65;
  }

  .cat-for     .kpi-count { color: #00e676; }
  .cat-against .kpi-count { color: #ff3d5a; }
  .cat-puck    .kpi-count { color: #00d4ff; }
  .cat-contest .kpi-count { color: #ffab40; }
  .cat-free    .kpi-count { color: #b388ff; }
  .cat-misc    .kpi-count { color: #90a4ae; }

  /* Flash overlay */
  .kpi-btn::after {
    content: ''; position: absolute; inset: 0;
    background: var(--flash); opacity: 0;
    border-radius: inherit; pointer-events: none;
    transition: opacity 0.05s;
  }
  .kpi-btn.flashing::after { opacity: 0.35; }

  /* Ripple */
  .ripple {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: scale(0);
    animation: ripple-anim 0.45s ease-out forwards;
    pointer-events: none;
  }
  @keyframes ripple-anim {
    0%   { transform: scale(0); opacity: 1; }
    100% { transform: scale(4); opacity: 0; }
  }

  /* â”€â”€ BOTTOM ROW â”€â”€ */
  #bottom-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
    flex-shrink: 0;
  }

  .action-btn {
    padding: 12px 4px;
    border-radius: var(--radius-sm);
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.5px; text-transform: uppercase;
    cursor: pointer; border: 1.5px solid;
    transition: background 0.2s, border-color 0.2s, color 0.2s;
    text-align: center; line-height: 1.3;
  }
  .action-btn:active { opacity: 0.72; transform: scale(0.95); }

  /* Flow button colours set dynamically via JS */
  #flow-btn    { font-size: 10px; }

  /* Pause button â€” two visual states */
  #pause-btn   {
    background: rgba(255,171,64,0.12);
    border-color: rgba(255,171,64,0.4);
    color: var(--amber);
  }
  #pause-btn.resuming {
    background: rgba(0,230,118,0.15);
    border-color: rgba(0,230,118,0.5);
    color: var(--green);
  }
  #pause-btn.disabled-btn {
    background: rgba(107,122,153,0.08);
    border-color: rgba(107,122,153,0.2);
    color: rgba(107,122,153,0.35);
    pointer-events: none;
  }

  #undo-btn    { background: rgba(255,61,90,0.12);   border-color: rgba(255,61,90,0.4);   color: var(--red);    }
  #display-btn { background: rgba(0,212,255,0.12);   border-color: rgba(0,212,255,0.4);   color: var(--accent); }
  #export-btn  { background: rgba(179,136,255,0.12); border-color: rgba(179,136,255,0.4); color: var(--purple); }

  /* Long-press hint ring on flow button */
  #flow-btn.long-pressing {
    box-shadow: 0 0 0 3px rgba(255,61,90,0.6);
  }

  /* â”€â”€ CONFIRM DIALOG â”€â”€ */
  #confirm-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.88); z-index: 200;
    align-items: center; justify-content: center;
    padding: 24px; backdrop-filter: blur(8px);
  }
  #confirm-overlay.visible { display: flex; }

  #confirm-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 28px 24px;
    max-width: 360px; width: 100%; text-align: center;
  }
  #confirm-box h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px; letter-spacing: 2px; margin-bottom: 10px;
  }
  #confirm-box p {
    font-size: 14px; color: var(--text-dim);
    line-height: 1.5; margin-bottom: 22px;
  }
  .confirm-btns { display: flex; gap: 10px; }
  .confirm-btns button {
    flex: 1; padding: 14px; border-radius: var(--radius-sm);
    font-size: 14px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase;
    cursor: pointer; border: 1.5px solid;
  }
  #confirm-yes          { background: var(--red);     border-color: var(--red);    color: #fff; }
  #confirm-yes.positive { background: var(--green);   border-color: var(--green);  color: #000; }
  #confirm-no           { background: var(--surface2); border-color: var(--border); color: var(--text); }

  /* â”€â”€ STATS MODAL â”€â”€ */
  #modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.85); z-index: 100;
    align-items: center; justify-content: center;
    padding: 14px; backdrop-filter: blur(6px);
  }
  #modal-overlay.visible { display: flex; }

  #modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; padding: 18px;
    width: 100%; max-width: 720px;
    max-height: 88vh; overflow-y: auto;
  }
  #modal-box h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px; letter-spacing: 2px;
    color: var(--accent); margin-bottom: 4px; text-align: center;
  }
  #modal-score-summary {
    text-align: center; font-size: 12px;
    color: var(--text-dim); margin-bottom: 14px;
    font-weight: 600; letter-spacing: 1px;
  }
  #stats-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  #stats-table th {
    background: var(--surface2); color: var(--text-dim);
    font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; padding: 9px 6px; text-align: center;
    border-bottom: 1px solid var(--border); position: sticky; top: 0;
  }
  #stats-table th:first-child { text-align: left; }
  #stats-table td {
    padding: 10px 6px; text-align: center;
    border-bottom: 1px solid rgba(30,45,69,0.5);
    font-weight: 600; color: var(--text);
  }
  #stats-table td:first-child {
    text-align: left; color: var(--text-dim);
    font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.4px;
  }
  #stats-table td.target-col {
    color: var(--amber); font-size: 11px; font-weight: 700;
  }
  #stats-table td.total-col { color: var(--accent); font-weight: 900; font-size: 15px; }
  #stats-table td.bad  { color: var(--red) !important; font-weight: 800; }
  #stats-table td.good { color: var(--green) !important; }
  #stats-table tr:last-child td { border-bottom: none; }
  #stats-table tr:hover td { background: rgba(255,255,255,0.03); }
  #close-modal-btn {
    margin-top: 14px; width: 100%; padding: 16px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text);
    font-size: 15px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
  }

  /* â”€â”€ CSV download modal (Safari fallback) â”€â”€ */
  #csv-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.88); z-index: 300;
    align-items: center; justify-content: center;
    padding: 24px; backdrop-filter: blur(8px);
  }
  #csv-overlay.visible { display: flex; }
  #csv-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 24px;
    max-width: 420px; width: 100%; text-align: center;
  }
  #csv-box h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; letter-spacing: 2px; color: var(--accent);
    margin-bottom: 8px;
  }
  #csv-box p { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; line-height: 1.5; }
  #csv-link {
    display: block; padding: 14px;
    background: rgba(179,136,255,0.15); border: 1.5px solid rgba(179,136,255,0.5);
    border-radius: var(--radius-sm); color: var(--purple);
    font-size: 14px; font-weight: 700; letter-spacing: 1px;
    text-decoration: none; text-transform: uppercase; margin-bottom: 10px;
  }
  #csv-close {
    width: 100%; padding: 12px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text-dim);
    font-size: 13px; font-weight: 700; cursor: pointer;
    letter-spacing: 1px; text-transform: uppercase;
  }

  /* â”€â”€ GAME OVER BANNER â”€â”€ */
  #game-over-banner {
    display: none; position: fixed; top: 0; left: 0; right: 0;
    background: linear-gradient(90deg, #00e676, #00d4ff);
    color: #000; text-align: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; letter-spacing: 3px;
    padding: 10px; z-index: 50;
  }
  #game-over-banner.visible { display: block; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed; bottom: 80px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 30px; padding: 8px 20px;
    font-size: 13px; font-weight: 600; color: var(--text-dim);
    opacity: 0; transition: all 0.25s; z-index: 400; white-space: nowrap;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="game-over-banner">â¬› Full Time â¬›</div>

<div id="app">

  <!-- SCOREBOARD -->
  <div id="scoreboard">
    <div class="score-team">
      <div class="score-label">Us</div>
      <div class="score-value" id="score-us">0-00</div>
    </div>
    <div id="match-info">
      <div id="quarter-label">Pre-Match</div>
      <div id="match-clock">00:00</div>
      <div id="game-status">Long-press Flow to reset</div>
    </div>
    <div class="score-team">
      <div class="score-label">Them</div>
      <div class="score-value" id="score-them">0-00</div>
    </div>
  </div>

  <!-- QUARTER INDICATOR PILLS -->
  <div id="quarter-row">
    <div class="qtr-pill" data-q="1">Qtr 1</div>
    <div class="qtr-pill" data-q="2">Qtr 2</div>
    <div class="qtr-pill" data-q="3">Qtr 3</div>
    <div class="qtr-pill" data-q="4">Qtr 4</div>
  </div>

  <!-- KPI GRID 4Ã—5 -->
  <div id="kpi-grid">
    <!-- Row 1: Play scoring -->
    <button class="kpi-btn cat-for"     data-kpi="Point (Play)"       onclick="logEvent(this,event)"><span class="kpi-label">Point (Play)</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-misc"    data-kpi="Shot Wide (Play)"   onclick="logEvent(this,event)"><span class="kpi-label">Shot Wide (Play)</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-free"    data-kpi="Point (Free/65)"    onclick="logEvent(this,event)"><span class="kpi-label">Point (Free/65)</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-misc"    data-kpi="Shot Wide (Free/65)" onclick="logEvent(this,event)"><span class="kpi-label">Shot Wide (Free/65)</span><span class="kpi-count">0</span></button>
    <!-- Row 2: Scoring against + goal for -->
    <button class="kpi-btn cat-against" data-kpi="Point Against"      onclick="logEvent(this,event)"><span class="kpi-label">Point Against</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-against" data-kpi="Wide Against"       onclick="logEvent(this,event)"><span class="kpi-label">Wide Against</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-against" data-kpi="Goal Against"       onclick="logEvent(this,event)"><span class="kpi-label">Goal Against</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-for"     data-kpi="Goal (Us)"          onclick="logEvent(this,event)"><span class="kpi-label">Goal (Us)</span><span class="kpi-count">0</span></button>
    <!-- Row 3: Puckouts -->
    <button class="kpi-btn cat-puck"    data-kpi="Pucks Won Us"       onclick="logEvent(this,event)"><span class="kpi-label">Pucks Won Us</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-puck"    data-kpi="Pucks Lost Us"      onclick="logEvent(this,event)"><span class="kpi-label">Pucks Lost Us</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-puck"    data-kpi="Pucks Won Them"     onclick="logEvent(this,event)"><span class="kpi-label">Pucks Won Them</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-puck"    data-kpi="Pucks Lost Them"    onclick="logEvent(this,event)"><span class="kpi-label">Pucks Lost Them</span><span class="kpi-count">0</span></button>
    <!-- Row 4: Contest & turnovers -->
    <button class="kpi-btn cat-misc"    data-kpi="Forced Turnovers"   onclick="logEvent(this,event)"><span class="kpi-label">Forced Turnovers</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-contest" data-kpi="Contested Won"      onclick="logEvent(this,event)"><span class="kpi-label">Contested Won</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-contest" data-kpi="Contested Lost"     onclick="logEvent(this,event)"><span class="kpi-label">Contested Lost</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-contest" data-kpi="Cleanly Lost"       onclick="logEvent(this,event)"><span class="kpi-label">Cleanly Lost</span><span class="kpi-count">0</span></button>
    <!-- Row 5: Frees + Run thru 65 -->
    <button class="kpi-btn cat-free"    data-kpi="Frees Won"          onclick="logEvent(this,event)"><span class="kpi-label">Frees Won</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-free"    data-kpi="Frees Lost"         onclick="logEvent(this,event)"><span class="kpi-label">Frees Lost</span><span class="kpi-count">0</span></button>
    <button class="kpi-btn cat-misc"    data-kpi="Run thru 65"        onclick="logEvent(this,event)"><span class="kpi-label">Run thru 65</span><span class="kpi-count">0</span></button>
  </div>

  <!-- BOTTOM ROW -->
  <div id="bottom-row">
    <button class="action-btn" id="flow-btn"    onclick="advanceGameFlow()">â–¶ Start Game</button>
    <button class="action-btn" id="pause-btn"   onclick="togglePause()">â¸ Pause</button>
    <button class="action-btn" id="undo-btn"    onclick="undoLast()">â†© Undo</button>
    <button class="action-btn" id="display-btn" onclick="showDisplay()">ğŸ“Š Stats</button>
    <button class="action-btn" id="export-btn"  onclick="exportCSV()">â¬‡ CSV</button>
  </div>

</div>

<!-- CONFIRM DIALOG -->
<div id="confirm-overlay">
  <div id="confirm-box">
    <h3 id="confirm-title">Are you sure?</h3>
    <p id="confirm-msg">This action cannot be undone.</p>
    <div class="confirm-btns">
      <button id="confirm-yes" onclick="confirmAction()">Confirm</button>
      <button id="confirm-no"  onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- STATS MODAL -->
<div id="modal-overlay" onclick="hideDisplay(event)">
  <div id="modal-box">
    <h2>Match Statistics</h2>
    <div id="modal-score-summary"></div>
    <table id="stats-table">
      <thead>
        <tr>
          <th>KPI Metric</th><th>Target</th><th>Qtr 1</th><th>Qtr 2</th><th>Qtr 3</th><th>Qtr 4</th><th>Total</th>
        </tr>
      </thead>
      <tbody id="stats-tbody"></tbody>
    </table>
    <button id="close-modal-btn" onclick="hideDisplay()">Close</button>
  </div>
</div>

<!-- CSV DOWNLOAD FALLBACK (Safari) -->
<div id="csv-overlay">
  <div id="csv-box">
    <h3>ğŸ“¥ Export CSV</h3>
    <p>Tap the link below to open, then use Share â†’ Save to Files.</p>
    <a id="csv-link" href="#">Download CSV</a>
    <button id="csv-close" onclick="closeCsvOverlay()">Close</button>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KPI_LIST = [
  'Point (Play)','Shot Wide (Play)','Point (Free/65)','Shot Wide (Free/65)',
  'Point Against','Wide Against','Goal Against','Goal (Us)',
  'Pucks Won Us','Pucks Lost Us','Pucks Won Them','Pucks Lost Them',
  'Forced Turnovers','Contested Won','Contested Lost','Cleanly Lost',
  'Frees Won','Frees Lost','Run thru 65'
];
const STORAGE_KEY = 'gaa_event_log_v6';
const STATE_KEY   = 'gaa_game_state_v6';

// Quarter boundaries (total match seconds, paused time excluded)
const Q1_Q2   = 15 * 60;  //  900 s â€” Q1â†’Q2 within 1st half
const H_START = 30 * 60;  // 1800 s â€” clock reads 30:00 at 2nd half kick-off
const Q3_Q4   = 45 * 60;  // 2700 s â€” Q3â†’Q4 within 2nd half

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
//
// gameFlow: 'pre' | 'first_half' | 'half_time' | 'second_half' | 'ended'
//
// Timing (all Date.now() ms):
//   firstHalfStart, firstHalfEnd, secondHalfStart, secondHalfEnd
//   pausedAt       â€” non-null when currently paused
//   firstHalfPausedMs  â€” total ms paused during 1st half
//   secondHalfPausedMs â€” total ms paused during 2nd half
//
// Clock formula:
//   1st half active  â†’ now - firstHalfStart - firstHalfPausedMs
//   half_time        â†’ firstHalfEnd - firstHalfStart - firstHalfPausedMs (frozen)
//   2nd half active  â†’ H_START + (now - secondHalfStart - secondHalfPausedMs)
//   ended            â†’ frozen at secondHalfEnd value
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let eventLog = [];
let state = {
  gameFlow: 'pre',
  firstHalfStart:     null,
  firstHalfEnd:       null,
  firstHalfPausedMs:  0,
  secondHalfStart:    null,
  secondHalfEnd:      null,
  secondHalfPausedMs: 0,
  pausedAt:           null,   // timestamp when pause started (null = not paused)
};

let clockInterval = null;
let pendingAction = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const savedLog   = localStorage.getItem(STORAGE_KEY);
  const savedState = localStorage.getItem(STATE_KEY);
  if (savedLog)   eventLog = JSON.parse(savedLog);
  if (savedState) state    = JSON.parse(savedState);
  refreshAll();
  clockInterval = setInterval(refreshClockDisplay, 500);
  registerServiceWorker();
  setupFlowLongPress();
}

function registerServiceWorker() {
  if ('serviceWorker' in navigator)
    navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MATCH SECONDS  (paused time excluded)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMatchSeconds(atMs) {
  const now = (atMs !== undefined) ? atMs : Date.now();

  if (state.gameFlow === 'pre') return 0;

  // --- first half elapsed ---
  let fhEnd = state.firstHalfEnd || now;
  // If currently paused during first half, freeze at pausedAt
  if (state.gameFlow === 'first_half' && state.pausedAt) fhEnd = state.pausedAt;
  const fhSecs = state.firstHalfStart
    ? Math.max(0, Math.floor((fhEnd - state.firstHalfStart - state.firstHalfPausedMs) / 1000))
    : 0;

  if (state.gameFlow === 'first_half' || state.gameFlow === 'half_time') return fhSecs;

  // --- second half elapsed ---
  let shEnd = state.secondHalfEnd || now;
  if (state.gameFlow === 'second_half' && state.pausedAt) shEnd = state.pausedAt;
  const shSecs = state.secondHalfStart
    ? Math.max(0, Math.floor((shEnd - state.secondHalfStart - state.secondHalfPausedMs) / 1000))
    : 0;

  return H_START + shSecs;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUARTER FROM SECONDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getQuarterFromSeconds(secs) {
  if (secs < Q1_Q2)   return 1;
  if (secs < H_START) return 2;
  if (secs < Q3_Q4)   return 3;
  return 4;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME FLOW BUTTON  (tap = advance, long-press = new game)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function advanceGameFlow() {
  switch (state.gameFlow) {
    case 'pre':         doStartGame();       break;
    case 'first_half':  doEndFirstHalf();    break;
    case 'half_time':   doStartSecondHalf(); break;
    case 'second_half': confirmEndGame();    break;
    case 'ended':
      showToast('Full Time â€” long-press â–¶ to start a new game');
      break;
  }
}

function doStartGame() {
  state.gameFlow           = 'first_half';
  state.firstHalfStart     = Date.now();
  state.firstHalfEnd       = null;
  state.firstHalfPausedMs  = 0;
  state.secondHalfStart    = null;
  state.secondHalfEnd      = null;
  state.secondHalfPausedMs = 0;
  state.pausedAt           = null;
  saveState();
  refreshAll();
  showToast('ğŸ Kick off â€” 1st Half');
}

function doEndFirstHalf() {
  // If paused when half-time called, count up the pause first
  if (state.pausedAt) {
    state.firstHalfPausedMs += Date.now() - state.pausedAt;
    state.pausedAt = null;
  }
  state.gameFlow    = 'half_time';
  state.firstHalfEnd = Date.now();
  saveState();
  refreshAll();
  showToast('â¸ Half Time');
}

function doStartSecondHalf() {
  state.gameFlow           = 'second_half';
  state.secondHalfStart    = Date.now();
  state.secondHalfEnd      = null;
  state.secondHalfPausedMs = 0;
  state.pausedAt           = null;
  saveState();
  refreshAll();
  showToast('â–¶ 2nd Half â€” clock at 30:00');
}

function doEndGame() {
  if (state.pausedAt) {
    state.secondHalfPausedMs += Date.now() - state.pausedAt;
    state.pausedAt = null;
  }
  state.gameFlow     = 'ended';
  state.secondHalfEnd = Date.now();
  saveState();
  document.getElementById('game-over-banner').classList.add('visible');
  refreshAll();
  showToast('â¹ Full Time');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PAUSE / RESUME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePause() {
  // Only valid during active halves
  if (state.gameFlow !== 'first_half' && state.gameFlow !== 'second_half') {
    showToast('Pause is only available during an active half');
    return;
  }

  if (state.pausedAt !== null) {
    // â”€â”€ RESUME â”€â”€
    const pauseDuration = Date.now() - state.pausedAt;
    if (state.gameFlow === 'first_half') {
      state.firstHalfPausedMs += pauseDuration;
    } else {
      state.secondHalfPausedMs += pauseDuration;
    }
    state.pausedAt = null;
    saveState();
    refreshAll();
    showToast('â–¶ Resumed');
  } else {
    // â”€â”€ PAUSE â”€â”€
    state.pausedAt = Date.now();
    saveState();
    refreshAll();
    showToast('â¸ Game paused');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LONG-PRESS on flow button â†’ New Game
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let longPressTimer  = null;
let longPressActive = false;

function setupFlowLongPress() {
  const btn = document.getElementById('flow-btn');

  function startLP(e) {
    longPressActive = false;
    btn.classList.add('long-pressing');
    longPressTimer = setTimeout(() => {
      longPressActive = true;
      btn.classList.remove('long-pressing');
      confirmNewGame();
    }, 800);
  }

  function cancelLP() {
    clearTimeout(longPressTimer);
    document.getElementById('flow-btn').classList.remove('long-pressing');
  }

  btn.addEventListener('touchstart', startLP, { passive: true });
  btn.addEventListener('touchend',   cancelLP, { passive: true });
  btn.addEventListener('touchcancel',cancelLP, { passive: true });
  // Also support mouse for desktop testing
  btn.addEventListener('mousedown',  startLP);
  btn.addEventListener('mouseup',    cancelLP);
  btn.addEventListener('mouseleave', cancelLP);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NEW GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmNewGame() {
  showConfirm(
    'âŠ• New Game',
    'Clear all match data and start fresh? (Stats & CSV of this game are still in localStorage until overwritten.)',
    doNewGame,
    false
  );
}

function doNewGame() {
  eventLog = [];
  state = {
    gameFlow: 'pre',
    firstHalfStart: null, firstHalfEnd: null, firstHalfPausedMs: 0,
    secondHalfStart: null, secondHalfEnd: null, secondHalfPausedMs: 0,
    pausedAt: null,
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));
  saveState();
  document.getElementById('game-over-banner').classList.remove('visible');
  refreshAll();
  showToast('New game ready â€” tap â–¶ Start Game');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIRM END GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmEndGame() {
  showConfirm(
    'â¹ End Game',
    'Mark the match as finished? Stats & CSV will still be available.',
    doEndGame,
    true
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIRM DIALOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(title, msg, action, isPositive) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent   = msg;
  document.getElementById('confirm-yes').className = isPositive ? 'positive' : '';
  pendingAction = action;
  document.getElementById('confirm-overlay').classList.add('visible');
}
function confirmAction() {
  closeConfirm();
  if (pendingAction) { pendingAction(); pendingAction = null; }
}
function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('visible');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LOGGING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logEvent(btn, evt) {
  if (state.pausedAt !== null) {
    showToast('Game is paused â€” tap â–¶ Resume first');
    return;
  }
  if (state.gameFlow === 'half_time') {
    showToast('Half Time â€” tap â–¶ 2nd Half to continue');
    return;
  }
  if (state.gameFlow === 'ended') {
    showToast('Game has ended');
    return;
  }
  // Auto-start if analyst taps KPI before pressing Start
  if (state.gameFlow === 'pre') doStartGame();

  const kpi     = btn.dataset.kpi;
  const now     = Date.now();
  const secs    = getMatchSeconds(now);
  const quarter = getQuarterFromSeconds(secs);
  const m = Math.floor(secs / 60).toString().padStart(2,'0');
  const s = (secs % 60).toString().padStart(2,'0');

  eventLog.push({ kpi, ts: now, quarter, time: `Q${quarter} ${m}:${s}` });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));

  triggerFlash(btn);
  triggerRipple(btn, evt);
  triggerScale(btn);
  refreshCounts();
  refreshScoreboard();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UNDO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function undoLast() {
  if (eventLog.length === 0) { showToast('Nothing to undo'); return; }
  const last = eventLog.pop();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(eventLog));
  showToast(`â†© Undid: ${last.kpi}`);
  refreshCounts();
  refreshScoreboard();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOCK DISPLAY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshClockDisplay() {
  const clockEl  = document.getElementById('match-clock');
  const statusEl = document.getElementById('game-status');
  const qlEl     = document.getElementById('quarter-label');
  const isPaused = state.pausedAt !== null;

  if (state.gameFlow === 'pre') {
    clockEl.textContent = '00:00';
    clockEl.classList.remove('paused');
    statusEl.textContent = 'Long-press Flow to reset';
    qlEl.textContent = 'Pre-Match';
    updateQtrPills(0);
    return;
  }

  const secs = getMatchSeconds();
  const m = Math.floor(secs / 60).toString().padStart(2,'0');
  const s = (secs % 60).toString().padStart(2,'0');
  clockEl.textContent = `${m}:${s}`;

  if (state.gameFlow === 'half_time') {
    clockEl.classList.add('paused');
    statusEl.textContent = 'Half Time';
    qlEl.textContent = 'Half Time';
    updateQtrPills(secs);
    return;
  }

  if (state.gameFlow === 'ended') {
    clockEl.classList.remove('paused');
    statusEl.textContent = 'Full Time';
    qlEl.textContent = 'Full Time';
    updateQtrPills(secs);
    return;
  }

  // Active half (possibly paused mid-half)
  if (isPaused) {
    clockEl.classList.add('paused');
    statusEl.textContent = 'Paused';
  } else {
    clockEl.classList.remove('paused');
    statusEl.textContent = 'Live';
  }
  const q = getQuarterFromSeconds(secs);
  qlEl.textContent = `Quarter ${q}`;
  updateQtrPills(secs);
}

function updateQtrPills(secs) {
  const isPre  = state.gameFlow === 'pre';
  const activeQ = isPre ? 0 : getQuarterFromSeconds(secs);

  document.querySelectorAll('.qtr-pill').forEach(el => {
    const q = parseInt(el.dataset.q);
    el.classList.remove('active','done');
    if (isPre) return;
    if (q === activeQ)    el.classList.add('active');
    else if (q < activeQ) el.classList.add('done');
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REFRESH ALL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll() {
  refreshCounts();
  refreshScoreboard();
  refreshFlowBtn();
  refreshPauseBtn();
  refreshClockDisplay();
}

function refreshFlowBtn() {
  const btn = document.getElementById('flow-btn');
  const map = {
    pre:         { label: 'â–¶ Start Game',   bg: 'rgba(0,230,118,0.15)',   bc: 'rgba(0,230,118,0.5)',   c: 'var(--green)'    },
    first_half:  { label: 'â¸ End 1st Half', bg: 'rgba(255,171,64,0.15)',  bc: 'rgba(255,171,64,0.5)',  c: 'var(--amber)'    },
    half_time:   { label: 'â–¶ 2nd Half',     bg: 'rgba(0,212,255,0.15)',   bc: 'rgba(0,212,255,0.5)',   c: 'var(--accent)'   },
    second_half: { label: 'â¹ End Game',     bg: 'rgba(255,61,90,0.15)',   bc: 'rgba(255,61,90,0.5)',   c: 'var(--red)'      },
    ended:       { label: 'â€” Full Time',    bg: 'rgba(107,122,153,0.10)', bc: 'rgba(107,122,153,0.3)', c: 'var(--text-dim)' },
  };
  const s = map[state.gameFlow] || map.pre;
  btn.textContent       = s.label;
  btn.style.background  = s.bg;
  btn.style.borderColor = s.bc;
  btn.style.color       = s.c;
}

function refreshPauseBtn() {
  const btn = document.getElementById('pause-btn');
  const canPause = state.gameFlow === 'first_half' || state.gameFlow === 'second_half';

  if (!canPause) {
    btn.className = 'action-btn disabled-btn';
    btn.textContent = 'â¸ Pause';
    return;
  }

  if (state.pausedAt !== null) {
    // Currently paused â€” show Resume
    btn.className = 'action-btn resuming';
    btn.textContent = 'â–¶ Resume';
  } else {
    btn.className = 'action-btn';
    btn.style.background  = 'rgba(255,171,64,0.12)';
    btn.style.borderColor = 'rgba(255,171,64,0.4)';
    btn.style.color       = 'var(--amber)';
    btn.textContent = 'â¸ Pause';
  }
}

function refreshCounts() {
  const counts = {};
  KPI_LIST.forEach(k => counts[k] = 0);
  eventLog.forEach(e => { if (counts[e.kpi] !== undefined) counts[e.kpi]++; });
  document.querySelectorAll('.kpi-btn').forEach(btn => {
    btn.querySelector('.kpi-count').textContent = counts[btn.dataset.kpi] ?? 0;
  });
}

function refreshScoreboard() {
  const gf = eventLog.filter(e => e.kpi === 'Goal (Us)').length;
  const pf = eventLog.filter(e => e.kpi === 'Point (Play)' || e.kpi === 'Point (Free/65)').length;
  const ga = eventLog.filter(e => e.kpi === 'Goal Against').length;
  const pa = eventLog.filter(e => e.kpi === 'Point Against').length;

  const usEl   = document.getElementById('score-us');
  const themEl = document.getElementById('score-them');
  const newUs   = `${gf}-${pf.toString().padStart(2,'0')}`;
  const newThem = `${ga}-${pa.toString().padStart(2,'0')}`;

  if (usEl.textContent !== newUs)     { usEl.textContent = newUs;     flashScore(usEl); }
  if (themEl.textContent !== newThem) { themEl.textContent = newThem; flashScore(themEl); }
}

function flashScore(el) {
  el.classList.add('flash-score');
  setTimeout(() => el.classList.remove('flash-score'), 400);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANIMATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerFlash(btn) {
  btn.classList.add('flashing');
  setTimeout(() => btn.classList.remove('flashing'), 200);
}

function triggerRipple(btn, evt) {
  const rect = btn.getBoundingClientRect();
  const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
  const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
  const size = Math.max(rect.width, rect.height);
  const r = document.createElement('span');
  r.className = 'ripple';
  r.style.cssText = `width:${size}px;height:${size}px;left:${x-size/2}px;top:${y-size/2}px`;
  btn.appendChild(r);
  setTimeout(() => r.remove(), 500);
}

function triggerScale(btn) {
  btn.style.transform = 'scale(0.90)';
  setTimeout(() => { btn.style.transform = 'scale(1.04)'; }, 100);
  setTimeout(() => { btn.style.transform = ''; }, 220);
  if (navigator.vibrate) navigator.vibrate(18);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS DISPLAY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDisplay() {
  // Build per-quarter counts for every raw KPI
  const raw = {};
  KPI_LIST.forEach(k => { raw[k] = {1:0,2:0,3:0,4:0}; });
  eventLog.forEach(e => { if (raw[e.kpi]) raw[e.kpi][e.quarter]++; });

  // Helper: get count for a kpi in a quarter
  const c = (kpi, q) => (raw[kpi] ? raw[kpi][q] : 0);

  // Helper: format percentage, returns '--' when denominator is 0
  const pct = (num, den) => den === 0 ? '--' : Math.round((num / den) * 100) + '%';

  // Determine the highest quarter that has been played (at least started)
  const maxPlayedQ = (() => {
    if (state.gameFlow === 'pre') return 0;
    if (state.gameFlow === 'ended') return 4;
    if (state.gameFlow === 'half_time') return 2;
    return getQuarterFromSeconds(getMatchSeconds());
  })();

  // Helper: build a <td> â€” colour any quarter that has been played
  function cell(display, isBad, q, isTotal = false) {
    let cls = isTotal ? 'total-col' : '';
    if (!isTotal && q <= maxPlayedQ) cls = isBad ? 'bad' : 'good';
    return `<td class="${cls}">${display}</td>`;
  }

  // Define 10 rows
  const rows = [
    {
      label: 'Our Scores',
      target: '5 / Qtr',
      targetVal: 5,
      // counts: sum of Point(Play) + Point(Free/65) + Goal(Us) â€” each goal = 1 score
      qval: q => c('Point (Play)',q) + c('Point (Free/65)',q) + c('Goal (Us)',q),
      total: () => [1,2,3,4].reduce((s,q)=> s + c('Point (Play)',q) + c('Point (Free/65)',q) + c('Goal (Us)',q), 0),
      bad: (v) => v < 5,  // red if below target
    },
    {
      label: 'Their Scores',
      target: '4 / Qtr',
      targetVal: 4,
      qval: q => c('Point Against',q) + c('Goal Against',q),
      total: () => [1,2,3,4].reduce((s,q)=> s + c('Point Against',q) + c('Goal Against',q), 0),
      bad: (v) => v > 4,  // red if above target
    },
    {
      label: 'Shots from Play Efficiency',
      target: '70% / Qtr',
      isPct: true,
      qval: q => { const n = c('Point (Play)',q); const d = n + c('Shot Wide (Play)',q); return {n,d}; },
      bad: (n,d) => d > 0 && (n/d) < 0.70,
    },
    {
      label: 'Shots from Spot Efficiency',
      target: '80% / Qtr',
      isPct: true,
      qval: q => { const n = c('Point (Free/65)',q); const d = n + c('Shot Wide (Free/65)',q); return {n,d}; },
      bad: (n,d) => d > 0 && (n/d) < 0.80,
    },
    {
      label: 'Total Shot Efficiency',
      target: '75% / Qtr',
      isPct: true,
      qval: q => {
        const n = c('Point (Play)',q) + c('Point (Free/65)',q);
        const d = n + c('Shot Wide (Play)',q) + c('Shot Wide (Free/65)',q);
        return {n,d};
      },
      bad: (n,d) => d > 0 && (n/d) < 0.75,
    },
    {
      label: 'Forced Turnovers',
      target: '2 / Qtr',
      qval: q => c('Forced Turnovers',q),
      total: () => [1,2,3,4].reduce((s,q)=> s + c('Forced Turnovers',q), 0),
      bad: (v) => v < 2,
    },
    {
      label: 'Conceded Turnovers',
      target: '2 / Qtr',
      qval: q => c('Cleanly Lost',q),
      total: () => [1,2,3,4].reduce((s,q)=> s + c('Cleanly Lost',q), 0),
      bad: (v) => v > 2,  // red if conceding too many
    },
    {
      label: 'Long Puckout Retention',
      target: '70% / Qtr',
      isPct: true,
      qval: q => { const n = c('Pucks Won Us',q); const d = n + c('Pucks Lost Us',q); return {n,d}; },
      bad: (n,d) => d > 0 && (n/d) < 0.70,
    },
    {
      label: 'Long Puckout Opp Success',
      target: '50% / Qtr',
      isPct: true,
      qval: q => { const n = c('Pucks Won Them',q); const d = n + c('Pucks Lost Them',q); return {n,d}; },
      bad: (n,d) => d > 0 && (n/d) < 0.50,
    },
    {
      label: 'Breaking Ball Success',
      target: '51% / Qtr',
      isPct: true,
      qval: q => { const n = c('Contested Won',q); const d = n + c('Contested Lost',q); return {n,d}; },
      bad: (n,d) => d > 0 && (n/d) < 0.51,
    },
    {
      label: 'Run Thru 65',
      target: '7 / Qtr',
      qval: q => c('Run thru 65',q),
      total: () => [1,2,3,4].reduce((s,q)=> s + c('Run thru 65',q), 0),
      bad: (v) => v < 7,
    },
  ];

  const tbody = document.getElementById('stats-tbody');
  tbody.innerHTML = '';

  rows.forEach(row => {
    const tr = document.createElement('tr');

    // KPI label cell
    let html = `<td>${row.label}</td>`;
    // Target cell
    html += `<td class="target-col">${row.target}</td>`;

    if (row.isPct) {
      // Percentage rows
      let totalN = 0, totalD = 0;
      [1,2,3,4].forEach(q => {
        const {n,d} = row.qval(q);
        totalN += n; totalD += d;
        const display = pct(n,d);
        const isBad = row.bad(n,d);
        html += cell(display, isBad, q);
      });
      html += `<td class="total-col">${pct(totalN,totalD)}</td>`;
    } else {
      // Count rows
      let total = 0;
      [1,2,3,4].forEach(q => {
        const v = row.qval(q);
        total += v;
        html += cell(v, row.bad(v), q);
      });
      const totalDisplay = row.total ? row.total() : total;
      html += `<td class="total-col">${totalDisplay}</td>`;
    }

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });

  const gf = eventLog.filter(e=>e.kpi==='Goal (Us)').length;
  const pf = eventLog.filter(e=>e.kpi==='Point (Play)'||e.kpi==='Point (Free/65)').length;
  const ga = eventLog.filter(e=>e.kpi==='Goal Against').length;
  const pa = eventLog.filter(e=>e.kpi==='Point Against').length;
  document.getElementById('modal-score-summary').textContent =
    `Us ${gf}-${pf.toString().padStart(2,'0')} (${gf*3+pf})  |  Them ${ga}-${pa.toString().padStart(2,'0')} (${ga*3+pa})`;

  document.getElementById('modal-overlay').classList.add('visible');
}

function hideDisplay(evt) {
  if (evt && evt.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('visible');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV EXPORT  â€” works at any game state, including after ended.
// Uses Blob + object URL. Safari on iPad may not auto-download, so we fall
// back to a visible link overlay the user can tap manually.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  if (eventLog.length === 0) { showToast('No events logged yet'); return; }

  // Build CSV string
  const lines = ['Event,Quarter,MatchTime,Timestamp_ms'];
  eventLog.forEach(e => {
    lines.push(`"${e.kpi}",${e.quarter},"${e.time}",${e.ts}`);
  });

  lines.push('','KPI Summary','KPI,Qtr1,Qtr2,Qtr3,Qtr4,Total');
  const data = {};
  KPI_LIST.forEach(k => { data[k] = {1:0,2:0,3:0,4:0}; });
  eventLog.forEach(e => { if (data[e.kpi]) data[e.kpi][e.quarter]++; });
  KPI_LIST.forEach(k => {
    const t = data[k][1]+data[k][2]+data[k][3]+data[k][4];
    lines.push(`"${k}",${data[k][1]},${data[k][2]},${data[k][3]},${data[k][4]},${t}`);
  });

  const csv      = lines.join('\n');
  const blob     = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url      = URL.createObjectURL(blob);
  const filename = `gaa_stats_${new Date().toISOString().slice(0,16).replace('T','_').replace(':','-')}.csv`;

  // Try the programmatic download approach first
  const a = document.createElement('a');
  a.href     = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // Safari often ignores the click â€” show fallback overlay after a short delay
  // so the user always has a way to get the file
  setTimeout(() => {
    // If the download attribute isn't supported (Safari < 15.4 on iPad)
    // show the manual tap overlay
    if (typeof a.download === 'undefined' || /iPad|iPhone/.test(navigator.userAgent)) {
      showCsvOverlay(url, filename);
    } else {
      URL.revokeObjectURL(url);
      showToast('CSV downloaded âœ“');
    }
  }, 300);
}

let csvBlobUrl = null;

function showCsvOverlay(url, filename) {
  if (csvBlobUrl) URL.revokeObjectURL(csvBlobUrl);
  csvBlobUrl = url;
  const link = document.getElementById('csv-link');
  link.href     = url;
  link.download = filename;
  link.textContent = `ğŸ“„ ${filename}`;
  document.getElementById('csv-overlay').classList.add('visible');
}

function closeCsvOverlay() {
  document.getElementById('csv-overlay').classList.remove('visible');
  if (csvBlobUrl) { URL.revokeObjectURL(csvBlobUrl); csvBlobUrl = null; }
  showToast('CSV ready â€” use Share â†’ Save to Files');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PERSIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveState() {
  localStorage.setItem(STATE_KEY, JSON.stringify(state));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
